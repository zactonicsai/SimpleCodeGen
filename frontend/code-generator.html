<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code Generator – Chroma + Ollama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100">
  <div class="max-w-5xl mx-auto py-8 px-4">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-slate-800">
          General Code Generator
        </h1>
        <p class="text-sm text-slate-600">
          Uses local ChromaDB for context and Ollama for generation.
        </p>
      </div>
      <a href="index.html"
         class="text-sm text-blue-600 hover:underline">← Back</a>
    </header>

    <!-- FORM CARD -->
    <div class="bg-white shadow rounded-xl p-6 mb-6">
      <form id="code-form" class="space-y-4">
        <!-- Prompt -->
        <div>
          <label for="prompt"
                 class="block text-sm font-medium text-slate-700 mb-1">
            What do you want to generate?
          </label>
          <textarea id="prompt" name="prompt" rows="5"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Example: Create a React component with a Tailwind form that has name, email, and message fields.">
          </textarea>
        </div>

        <!-- Code Type -->
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label for="code_type"
                   class="block text-sm font-medium text-slate-700 mb-1">
              Code type / Language (optional)
            </label>
            <select id="code_type" name="code_type"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">Let the model decide</option>
              <option value="html+tailwind">HTML + Tailwind</option>
              <option value="react+tailwind">React + Tailwind</option>
              <option value="javascript">JavaScript</option>
              <option value="python">Python</option>
              <option value="node">Node.js / Express</option>
            </select>
          </div>

          <div>
            <label for="n_results"
                   class="block text-sm font-medium text-slate-700 mb-1">
              Number of context snippets (from Chroma)
            </label>
            <input id="n_results" name="n_results" type="number" min="1" max="5" value="3"
                   class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
          </div>
        </div>

        <!-- Button + Status -->
        <div class="flex items-center gap-4">
          <button type="submit"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span id="btn-text">Generate Code</span>
            <svg id="spinner" class="hidden animate-spin h-4 w-4"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10"
                      stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          </button>

          <p id="status"
             class="text-xs text-slate-500"></p>
        </div>
      </form>
    </div>

    <!-- OUTPUT -->
    <div class="grid gap-6 md:grid-cols-2">
      <!-- Generated Code -->
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="text-sm font-semibold text-slate-700 mb-2">
          Generated Code
        </h2>
        <pre id="output"
             class="text-xs bg-slate-900 text-slate-100 rounded-lg p-3 overflow-auto min-h-[250px] whitespace-pre-wrap"></pre>
      </div>

      <!-- Context used -->
      <div class="bg-white shadow rounded-xl p-4">
        <h2 class="text-sm font-semibold text-slate-700 mb-2">
          Context (from ChromaDB)
        </h2>
        <pre id="context"
             class="text-xs bg-slate-900 text-slate-100 rounded-lg p-3 overflow-auto min-h-[250px] whitespace-pre-wrap"></pre>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('code-form');
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const contextEl = document.getElementById('context');
    const spinner = document.getElementById('spinner');
    const btnText = document.getElementById('btn-text');

    const API_BASE = 'http://localhost:8000'; // adjust if needed

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const prompt = document.getElementById('prompt').value.trim();
      const code_type = document.getElementById('code_type').value;
      const n_results = parseInt(document.getElementById('n_results').value || '3', 10);

      if (!prompt) {
        statusEl.textContent = 'Please enter a prompt first.';
        return;
      }

      statusEl.textContent = 'Calling backend...';
      spinner.classList.remove('hidden');
      btnText.textContent = 'Generating...';

      try {
        const resp = await fetch(`${API_BASE}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, code_type, n_results })
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }

        const data = await resp.json();
        outputEl.textContent = data.output || '';
        contextEl.textContent = (data.used_context || []).join('\n\n---\n\n');
        statusEl.textContent = 'Done.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error calling backend. See console.';
        outputEl.textContent = String(err);
      } finally {
        spinner.classList.add('hidden');
        btnText.textContent = 'Generate Code';
      }
    });
  </script>
</body>
</html>
